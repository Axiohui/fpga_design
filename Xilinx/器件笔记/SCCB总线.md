前身：I2C
---------

**I2C总线规范：面向8位数字控制应用，譬如要求微控制器FPGA/ARM .etc**

• 系统通常由至少一个微控制器和其他外围器件例如存储器和I/O 扩展器组成
• 系统中不同器件的连接成本必须最小
• 执行控制功能的系统不要求高速的数据传输

- 系统需要一个 串行的总线结构
- 总线不依赖于特定器件（包括主从器件）
- 过程决定哪些器件何时可以控制总线
- 不同时钟的器件连接到总线，必须定义总线的时钟源
- **总线不仅包括互连线还包含系统通讯的所有格式和过程**（即协议）

**I2C总线的概念**

1. 串行数据SDA和串行时钟SCL线：双向线路；通过一个电流源或上拉电阻连接到正的电源电压，连接到总线的器件输出级必须是漏极开路或集电极开路才能执行线与的功能；当总线空闲时，串行数据SDA和串行时钟SCL都是高电平
2. 器件有唯一的地址识别
3. 在I2C 总线上产生时钟信号通常是主机器件的责任（总线上传输数据时每个主机产生自己的时钟信号）
4. 传输速率在标准模式下可达100kbit/s 在快速模式下可达400kbit/s 在高速模式下可达3.4Mbit/s 

![](http://i.imgur.com/lGPwQt8.jpg)

**多主机的问题:多个主机可以同时尝试初始化传输数据：仲裁过程**

1. 通过线与连接 所有I2C总线接口到I2C总线
2. 若两个或多个主机尝试发送信息到SDA 线，在其他主机都产生0 的情况下，首先产生一个1 的主机将丢失仲裁
3. 仲裁时钟信号是用线与连接到SCL 线的主机产生的同步时钟结合?

**位传输：电气特性由VDD 的相关电平决定（LVCMOS/LVTTL总线连接的器件的工艺不同 .etc）**

![](http://i.imgur.com/TqoZ3Qr.jpg)

1. 传输时数据位的有效性：SDA 线上的数据必须在SCL 线的高电平周期保持稳定；SDA 线的高或低电平状态变化只有在SCL 线是低电平时才能改变。
2. 起始S 和停止P 
	
	1. 起始条件：SCL 线是高电平时，SDA 线从高电平向低电平切换：总线在起始条件后被认为处于忙的状态
	2. 停止条件：SCL 线是高电平时，SDA 线由低电平向高电平切换：停止条件的某段时间后总线被认为再次处于空闲状态
	3. 重复起始Sr 条件：替代停止条件后，总线会一直处于忙的状态

如果连接到总线的器件含有必要的接口硬件，那么检测起始和停止条件十分简便。
如果没有接口的微控制器，至少要采样SDA 线两次来判别有没有发生电平切换。

![](http://i.imgur.com/T8TCT9R.jpg)

**传输数据**

![](http://i.imgur.com/kBp64JZ.jpg)

字节格式：发送到SDA 线上的每个字节必须为8 位，每次传输可以发送的字节数量不受限制。每个字节后必须跟一个响应位。

1. 首先传输的是数据最高位MSB。每传输一位数据，就会对应一个时钟脉冲（高电平对应数据位，低电平对应数据改变）。
2. 如果从机要完成一些其他功能，例如一个内部中断服务，程序才能接收或发送下一个完整的字节，可以使SCL线 保持低电平迫使主机进入等待状态；当从机准备好接收下一个字节并释放SCL线 后传输继续

**响应**

![](http://i.imgur.com/B2yg2Ea.jpg)

1. 响应时钟脉冲由主机产生
2. 响应时钟脉冲期间，发送器释放SDA 线（保持高电平：开漏特性）；接收器必须将SDA 线拉低使其在响应时钟脉冲的高电平期间保持稳定的低电平（必须考虑建立和保持时间）
3. 接收器在接收到的每个字节后（除了用CBUS 地址开头）都必须产生一个响应

- 当从机不能响应从机地址时，例如它正在执行一些实时函数不能接收或发送，从机必须使数据线保持高电平，然后主机产生一个停止条件终止传输或者产生重复起始条件开始新的传输；
- 当从机-接收器响应从机地址，但是在传输一段时间后不能接收更多字节，主机必须再一次终止传输（即从机使数据线保持高电平主机产生一个停止或重复起始条件）。以 “从机在第一个字节后没有产生响应” 来表示。
- 当传输中有主机-接收器，其必须通过 “在从机不产生时钟的最后一个字节不产生一个响应” 向从机-发送器通知数据结束。从机-发送器必须释放数据线，允许主机产生一个停止或重复起始条件

**仲裁和时钟同步：略**

1. 主机(s) 在SCL 线上产生自己的时钟来传输数据
2. I2C 总线上的报文数据只在时钟的高电平周期有效

![](http://i.imgur.com/4sCpHTL.jpg)

**7位地址格式**

![](http://i.imgur.com/Tk4YR2L.jpg)

1. 起始条件S 后发送一个从机地址（7 位）
2. 第8 位是数据方向位R/W（0 表示发送，1 表示请求数据读）
3. 数据传输
3. 最后由主机产生的停止位P 终止；若主机仍希望在总线上通讯，可以产生重复起始条件Sr以及寻址另一个从机

数据传输格式：

• 主机-发送器发送到从机-接收器传输的方向不会改变

![](http://i.imgur.com/VxiTIOc.jpg)

• 在第一次响应时主机-发送器变成主机-接收器，从机-接收器变成从机-发送器；第一次响应仍由从机产生，之前发送不响应信号A的主机产生停止条件

![](http://i.imgur.com/p5xGuxY.jpg)

• 传输方向改变的时侯 起始条件和从机地址都会被重复，但R/W 位取反；如果主机-接收器发送一个重复起始条件，之前应该发送一个不响应信号A

![](http://i.imgur.com/x7dVcyt.jpg)

1. 复合格式可以用于例如控制一个串行存储器在第一个数据字节期间要写内部存储器的位置；在重复起始条件和从机地址后数据可被传输
2. 自动增加或减少之前访问的存储器位置等所有决定都由器件的设计者决定
3. 每个字节都跟着一个响应位,在序列中用A 或A 模块表示
4. 兼容I2C 总线的器件在接收到起始或重复起始条件时必须复位它们的总线逻辑,甚至在这些起始条件没有根据正确的格式放置,它们也都期望发送从机地址
5. 起始条件后面立即跟着一个停止条件报文为空是一个不合法的格式

**7 位寻址**

1. 通常在起始条件后的第一个字节 决定了主机选择哪一个从机
2. 例外的情况是可以寻址所有器件的广播呼叫地址
3. 使用这个地址时理论上所有器件都会发出一个响应，但是也可以使器件忽略这个地址

- 第一个字节的头7 位组成从机地址（唯一标识）；若有4 个固定和3 个可编程地址位，那么总线上共可以连接8（2^3）个器件

	1. 固定部分
	2. 可编程部分

- 最低位LSB 即第8 位，决定报文的方向（发送/接收）

特殊类型地址：

![](http://i.imgur.com/mF9TQqJ.jpg)

**广播呼叫地址/CBUS 的兼容性：略**

**起始字节**

•  起始条件 S
•  起始字节 0000000
•  响应时钟脉冲 ACK
•  重复起始条件 Sr

![](http://i.imgur.com/RRhKnN6.jpg)

1. 主机发送起始条件S 
2. 发送起始字节00000001 
2. 另微控制器可以低采样速率 采样SDA 线，直到检测到7个0
3. SDA 线检测到低电平后，微控制器切换到一个更高的采样速率，寻找用于同步的重复起始条件Sr
4. 接收到重复起始条件Sr 后，硬件接收器会复位且忽略起始字节
5. 起始字节后产生一响应时钟脉冲，仅在遵守总线的字节处理格式时出现。


SCCB是OmniVision公司定制的**串行**摄像头控制总线(Serial Camera Control Bus),用于对摄像头**寄存器**进行读写,以达到对输出图像的控制。

**SCCB与I2C总线类似,双向二线制同步串行总线**

1 SCCB的数据传输由主器件控制,主器件能够发出数据传输启动信号、时钟信号以及传送结束时的停止信号。通常主器件都是微处理器,它寻址访问的设备称为从器件。为了进行通讯,每个接到SCCB 的设备都有一个唯一的地址(ID) ,使用软件来识别总线上的从器件,省去了从器件的片选。因此,只需要两根线(串行时钟线SIO C 和串行数据线SIO D) ,挂接到总线上的器件就能相互进行信息传递。{与I2C一模一样}

2 组成SCCB 的SIO C 和SIO D必须经过上拉电阻RP 接到正电源上,连接到总线的器件的输出级必需为“开漏”或“开集”的形式以便在多个主或从需求仲裁的况下完成线与的功能。

3 在SCCB 协议中定义开始和停止条件如下:

开始条件:在SIO C 为高电平时,SIO 出现一个下降则SCCB 开始传输;停止条件:在SIO C 为高电平时,SIO D 出现一个上升沿,则SCCB 停止传输。
除了开始和停止状态,在数据传输时,当SIO C 为高电平时,必需保证SIO D上的数据的稳定,也就是说,SIO D 上的数据只能在SIO C 为低电平时改变。

4 与I2C 总线类似,SCCB 的完整的数据传输包括两、三个阶段。

每一阶段中包含9 位二进制数据,其中高8 位为所要传输的8 位数据,最低位根据主器件的数据传输是读操作还是写操作而确定

- 在进行主器件写操作时,全部阶段的最低位均是无关位(低或高电平均可)
- 读操作时,第一阶段的最低位是无关位,第二阶段的最低位为NA———主器件驱动为高电平有效

5 在SCCB 协议定义了两种写操作,即三相写操作和两相写操作。

1. 三相写操作是往 从器件的目的寄存器中写入数据。在三相写操作中,第一阶段写从器件的8 位IDW 和无关位,第二阶段写从器件目标寄存器的8 位地址和无关位,第三阶段写要求写入寄存器的8 位数据和无关位
2. 两相写操作只有三相写操作的前两个阶段。两相写操作的目的是为了确定读操作中的从器件地址,这是因为两相读操作不能提供所要求读取的寄存器的地址。

6 SCCB 协议定义了两读操作,它用于读取从器件目的寄存器中的数据。

1. 在第一阶段中读从器件的8 位IDR 和无关位,在第二阶段中读取寄存器中的8 位数据和写NA bit
2. 在两阶段读循环操作前,必需有一个两相或三相的写循环操作,以提供读操作中的寄存器地址

**总线和I2C总线区别**

SCCB是简化的I2C协议，SIO-I是串行时钟输入线，SIO-O是串行双向数据线，分别相当于I2C协议的SCL和SDA。

1 SCCB的总线时序与I2C基本相同，它的响应信号ACK被称为一个传输单元的第9位，分为Don’t care和NA。

- Don’t care位由从机产生
- NA位由主机产生，由于SCCB不支持多字节的读写，NA位必须为高电平

2 SCCB没有重复起始的概念，因此在SCCB的读周期中，当主机发送完片内寄存器地址后，必须发送总线停止条件。不然在发送读命令时，从机将不能产生Don’t care响应信号。

3 由于I2C和SCCB的一些细微差别，所以采用GPIO模拟SCCB总线的方式。SCL所连接的引脚始终设为输出方式，而SDA所连接的引脚在数据传输过程中，通过设置IODIR的值，动态改变引脚的输入/输出方式。

4 SCCB的写周期直接使用I2C总线协议的写周期时序;而SCCB的读周期，则增加一个总线停止条件。

5 SCCB总线通信协议只支持100Kbs或400Kbs的传输速度，并且支持两种地址形式：

1. 从设备地址（ID Address，8bit），分为读地址和写地址，高7位用于选中芯片， 第0位是读写控制位（RW），决定是对该芯片进行读或写操作；
2. 内部寄存器单元地址（Sub_ Address，8bit），用于决定对内部的哪个寄存器单元进行操作，通常还支持地址单元连续的多字节顺序读写操作。

6 SCCB控制总线功能的实现完全是依靠SIO_C、SIO_D两条总线上电平的状态以及两者之间的相互配合实现的。

7 SCCB总线传输的启动和停止条件：

	1. 采用简单的三相(Phase)写数据的方式，即在写寄存器的过程中先发送OV7649的ID地址（ID Address），然后发送写数据的目地寄存器地址（Sub_address），最后发送要写入的数据（Write Data）。
	2. 如果给**连续的寄存器写数据**，写完一个寄存器后，OV7649会自动把寄存器地址加1，程序可继续向下写，而不需要再次输入ID地址，从而三相写数据变为了两相写数据。
	3. 若只需对有限个**不连续寄存器**进行配置，如果采用对全部寄存器都加以配置这一方法的话，会浪费很多时间和资源，所以我们只对需要更改数据的寄存器进行写数据。对于每一个不连续（需要更改）的寄存器，都采用三相写数据的方法。